// src/install/install.ts
import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";
var __filename2 = fileURLToPath(import.meta.url);
var __dirname2 = path.dirname(__filename2);
var ROOT = path.dirname(__dirname2);
var NAMESPACE_PREFIX = "ai-eng";
async function cleanNamespacedDirectory(baseDir, subdir, namespace, silent = false) {
  const dir = path.join(baseDir, subdir, namespace);
  if (fs.existsSync(dir)) {
    fs.rmSync(dir, { recursive: true, force: true });
    if (!silent) {
      console.log(`  ✅ Cleaned existing ${subdir}/${namespace}/`);
    }
  }
}
async function cleanAiEngSkills(targetOpenCodeDir, distOpenCodeDir, silent = false) {
  const targetSkillDir = path.join(targetOpenCodeDir, "skill");
  const distSkillDir = path.join(distOpenCodeDir, "skill");
  if (!fs.existsSync(distSkillDir))
    return;
  const aiEngSkillNames = fs.readdirSync(distSkillDir, { withFileTypes: true }).filter((entry) => entry.isDirectory()).map((entry) => entry.name);
  if (aiEngSkillNames.length === 0)
    return;
  let cleanedCount = 0;
  for (const skillName of aiEngSkillNames) {
    const skillPath = path.join(targetSkillDir, skillName);
    if (fs.existsSync(skillPath)) {
      fs.rmSync(skillPath, { recursive: true, force: true });
      cleanedCount++;
    }
  }
  if (!silent && cleanedCount > 0) {
    console.log(`  ✅ Cleaned ${cleanedCount} existing ai-eng skills`);
  }
}
function isPluginReferenced(configPath) {
  try {
    const configContent = fs.readFileSync(configPath, "utf-8");
    const config = JSON.parse(configContent);
    if (Array.isArray(config.plugin)) {
      return config.plugin.includes("ai-eng-system");
    }
    return false;
  } catch {
    return false;
  }
}
function findOpenCodeConfig(projectDir) {
  const homeDir = process.env.HOME || process.env.USERPROFILE || "";
  const projectConfig = path.join(projectDir, ".opencode", "opencode.jsonc");
  if (fs.existsSync(projectConfig)) {
    return { path: projectConfig, isGlobal: false };
  }
  const globalConfig = path.join(homeDir, ".config", "opencode", "opencode.jsonc");
  if (fs.existsSync(globalConfig)) {
    return { path: globalConfig, isGlobal: true };
  }
  return null;
}
function detectInstallationScope(projectDir) {
  const config = findOpenCodeConfig(projectDir);
  if (config)
    return config.isGlobal ? "global" : "project";
  if (fs.existsSync(path.join(projectDir, "package.json"))) {
    return "project";
  }
  return "global";
}
async function runInstaller(flags) {
  const projectDir = process.cwd();
  const homeDir = process.env.HOME || process.env.USERPROFILE || "";
  const distOpenCodeDir = path.join(ROOT, "dist", ".opencode");
  let scope = flags.scope;
  if (!scope || scope === "auto") {
    const detected = detectInstallationScope(projectDir);
    if (!detected) {
      console.log("❌ Could not detect installation scope. Use --scope project|global");
      process.exit(1);
    }
    scope = detected;
  }
  const targetOpenCodeDir = scope === "global" ? path.join(homeDir, ".config", "opencode") : path.join(projectDir, ".opencode");
  if (flags.verbose) {
    console.log(`Installing to: ${targetOpenCodeDir}`);
    console.log(`Scope: ${scope}`);
  }
  if (scope === "project") {
    const opencodeDir = path.join(projectDir, ".opencode");
    if (!fs.existsSync(opencodeDir)) {
      console.log("❌ No .opencode/ directory found in project");
      console.log("   Run 'opencode init' first or use --scope global");
      process.exit(1);
    }
  }
  const config = findOpenCodeConfig(projectDir);
  if (config && !isPluginReferenced(config.path)) {
    console.log("⚠️  opencode.jsonc does not reference ai-eng-system plugin");
    console.log("   Add 'ai-eng-system' to the plugin array in opencode.jsonc");
  }
  if (flags.dryRun) {
    console.log("\uD83D\uDD0D dry-run: Would install the following files:");
    console.log(`   Commands -> ${targetOpenCodeDir}/command/${NAMESPACE_PREFIX}/`);
    console.log(`   Agents   -> ${targetOpenCodeDir}/agent/${NAMESPACE_PREFIX}/`);
    console.log(`   Skills   -> ${targetOpenCodeDir}/skill/`);
    return;
  }
  const commandsDir = path.join(targetOpenCodeDir, "command", NAMESPACE_PREFIX);
  const distCommandsDir = path.join(distOpenCodeDir, "command", NAMESPACE_PREFIX);
  if (fs.existsSync(distCommandsDir)) {
    await cleanNamespacedDirectory(targetOpenCodeDir, "command", NAMESPACE_PREFIX);
    fs.cpSync(distCommandsDir, commandsDir, { recursive: true });
    console.log(`  ✅ Installed commands to ${commandsDir}`);
  }
  const agentsDir = path.join(targetOpenCodeDir, "agent", NAMESPACE_PREFIX);
  const distAgentsDir = path.join(distOpenCodeDir, "agent", NAMESPACE_PREFIX);
  if (fs.existsSync(distAgentsDir)) {
    await cleanNamespacedDirectory(targetOpenCodeDir, "agent", NAMESPACE_PREFIX);
    fs.cpSync(distAgentsDir, agentsDir, { recursive: true });
    console.log(`  ✅ Installed agents to ${agentsDir}`);
  }
  const skillsDir = path.join(targetOpenCodeDir, "skill");
  const distSkillsDir = path.join(distOpenCodeDir, "skill");
  if (fs.existsSync(distSkillsDir)) {
    await cleanAiEngSkills(targetOpenCodeDir, distOpenCodeDir);
    fs.cpSync(distSkillsDir, skillsDir, { recursive: true });
    console.log(`  ✅ Installed skills to ${skillsDir}`);
  }
  console.log(`
✅ Installation complete!`);
  console.log("   Restart OpenCode or Claude Code to use new commands and agents.");
}
export {
  runInstaller
};

//# debugId=E8F1BA79A0F9740064756E2164756E21
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vc3JjL2luc3RhbGwvaW5zdGFsbC50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsKICAgICIvKipcbiAqIGFpLWVuZyBpbnN0YWxsIGNvbW1hbmRcbiAqXG4gKiBJbnN0YWxscyBPcGVuQ29kZS9DbGF1ZGUgYXNzZXRzIHRvIHByb2plY3Qgb3IgZ2xvYmFsIGxvY2F0aW9uLlxuICogUmVwbGFjZXMgdGhlIGF1dG9tYXRpYyBwb3N0aW5zdGFsbCBiZWhhdmlvci5cbiAqL1xuXG5pbXBvcnQgZnMgZnJvbSBcIm5vZGU6ZnNcIjtcbmltcG9ydCBwYXRoIGZyb20gXCJub2RlOnBhdGhcIjtcbmltcG9ydCB7IGZpbGVVUkxUb1BhdGggfSBmcm9tIFwibm9kZTp1cmxcIjtcblxuY29uc3QgX19maWxlbmFtZSA9IGZpbGVVUkxUb1BhdGgoaW1wb3J0Lm1ldGEudXJsKTtcbmNvbnN0IF9fZGlybmFtZSA9IHBhdGguZGlybmFtZShfX2ZpbGVuYW1lKTtcbmNvbnN0IFJPT1QgPSBwYXRoLmRpcm5hbWUoX19kaXJuYW1lKTtcbmNvbnN0IE5BTUVTUEFDRV9QUkVGSVggPSBcImFpLWVuZ1wiO1xuXG5pbnRlcmZhY2UgSW5zdGFsbEZsYWdzIHtcbiAgICBzY29wZT86IFwicHJvamVjdFwiIHwgXCJnbG9iYWxcIiB8IFwiYXV0b1wiO1xuICAgIGRyeVJ1bj86IGJvb2xlYW47XG4gICAgeWVzPzogYm9vbGVhbjtcbiAgICB2ZXJib3NlPzogYm9vbGVhbjtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2xlYW5OYW1lc3BhY2VkRGlyZWN0b3J5KFxuICAgIGJhc2VEaXI6IHN0cmluZyxcbiAgICBzdWJkaXI6IHN0cmluZyxcbiAgICBuYW1lc3BhY2U6IHN0cmluZyxcbiAgICBzaWxlbnQgPSBmYWxzZSxcbik6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGRpciA9IHBhdGguam9pbihiYXNlRGlyLCBzdWJkaXIsIG5hbWVzcGFjZSk7XG4gICAgaWYgKGZzLmV4aXN0c1N5bmMoZGlyKSkge1xuICAgICAgICBmcy5ybVN5bmMoZGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSwgZm9yY2U6IHRydWUgfSk7XG4gICAgICAgIGlmICghc2lsZW50KSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgICDinIUgQ2xlYW5lZCBleGlzdGluZyAke3N1YmRpcn0vJHtuYW1lc3BhY2V9L2ApO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBjbGVhbkFpRW5nU2tpbGxzKFxuICAgIHRhcmdldE9wZW5Db2RlRGlyOiBzdHJpbmcsXG4gICAgZGlzdE9wZW5Db2RlRGlyOiBzdHJpbmcsXG4gICAgc2lsZW50ID0gZmFsc2UsXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB0YXJnZXRTa2lsbERpciA9IHBhdGguam9pbih0YXJnZXRPcGVuQ29kZURpciwgXCJza2lsbFwiKTtcbiAgICBjb25zdCBkaXN0U2tpbGxEaXIgPSBwYXRoLmpvaW4oZGlzdE9wZW5Db2RlRGlyLCBcInNraWxsXCIpO1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhkaXN0U2tpbGxEaXIpKSByZXR1cm47XG5cbiAgICBjb25zdCBhaUVuZ1NraWxsTmFtZXMgPSBmc1xuICAgICAgICAucmVhZGRpclN5bmMoZGlzdFNraWxsRGlyLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSlcbiAgICAgICAgLmZpbHRlcigoZW50cnkpID0+IGVudHJ5LmlzRGlyZWN0b3J5KCkpXG4gICAgICAgIC5tYXAoKGVudHJ5KSA9PiBlbnRyeS5uYW1lKTtcblxuICAgIGlmIChhaUVuZ1NraWxsTmFtZXMubGVuZ3RoID09PSAwKSByZXR1cm47XG5cbiAgICBsZXQgY2xlYW5lZENvdW50ID0gMDtcbiAgICBmb3IgKGNvbnN0IHNraWxsTmFtZSBvZiBhaUVuZ1NraWxsTmFtZXMpIHtcbiAgICAgICAgY29uc3Qgc2tpbGxQYXRoID0gcGF0aC5qb2luKHRhcmdldFNraWxsRGlyLCBza2lsbE5hbWUpO1xuICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhza2lsbFBhdGgpKSB7XG4gICAgICAgICAgICBmcy5ybVN5bmMoc2tpbGxQYXRoLCB7IHJlY3Vyc2l2ZTogdHJ1ZSwgZm9yY2U6IHRydWUgfSk7XG4gICAgICAgICAgICBjbGVhbmVkQ291bnQrKztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlmICghc2lsZW50ICYmIGNsZWFuZWRDb3VudCA+IDApIHtcbiAgICAgICAgY29uc29sZS5sb2coYCAg4pyFIENsZWFuZWQgJHtjbGVhbmVkQ291bnR9IGV4aXN0aW5nIGFpLWVuZyBza2lsbHNgKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGlzUGx1Z2luUmVmZXJlbmNlZChjb25maWdQYXRoOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBjb25maWdDb250ZW50ID0gZnMucmVhZEZpbGVTeW5jKGNvbmZpZ1BhdGgsIFwidXRmLThcIik7XG4gICAgICAgIGNvbnN0IGNvbmZpZyA9IEpTT04ucGFyc2UoY29uZmlnQ29udGVudCk7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvbmZpZy5wbHVnaW4pKSB7XG4gICAgICAgICAgICByZXR1cm4gY29uZmlnLnBsdWdpbi5pbmNsdWRlcyhcImFpLWVuZy1zeXN0ZW1cIik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gY2F0Y2gge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBmaW5kT3BlbkNvZGVDb25maWcoXG4gICAgcHJvamVjdERpcjogc3RyaW5nLFxuKTogeyBwYXRoOiBzdHJpbmc7IGlzR2xvYmFsOiBib29sZWFuIH0gfCBudWxsIHtcbiAgICBjb25zdCBob21lRGlyID0gcHJvY2Vzcy5lbnYuSE9NRSB8fCBwcm9jZXNzLmVudi5VU0VSUFJPRklMRSB8fCBcIlwiO1xuXG4gICAgLy8gQ2hlY2sgcHJvamVjdCAub3BlbmNvZGUvXG4gICAgY29uc3QgcHJvamVjdENvbmZpZyA9IHBhdGguam9pbihwcm9qZWN0RGlyLCBcIi5vcGVuY29kZVwiLCBcIm9wZW5jb2RlLmpzb25jXCIpO1xuICAgIGlmIChmcy5leGlzdHNTeW5jKHByb2plY3RDb25maWcpKSB7XG4gICAgICAgIHJldHVybiB7IHBhdGg6IHByb2plY3RDb25maWcsIGlzR2xvYmFsOiBmYWxzZSB9O1xuICAgIH1cblxuICAgIC8vIENoZWNrIGdsb2JhbCB+Ly5jb25maWcvb3BlbmNvZGUvXG4gICAgY29uc3QgZ2xvYmFsQ29uZmlnID0gcGF0aC5qb2luKFxuICAgICAgICBob21lRGlyLFxuICAgICAgICBcIi5jb25maWdcIixcbiAgICAgICAgXCJvcGVuY29kZVwiLFxuICAgICAgICBcIm9wZW5jb2RlLmpzb25jXCIsXG4gICAgKTtcbiAgICBpZiAoZnMuZXhpc3RzU3luYyhnbG9iYWxDb25maWcpKSB7XG4gICAgICAgIHJldHVybiB7IHBhdGg6IGdsb2JhbENvbmZpZywgaXNHbG9iYWw6IHRydWUgfTtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbn1cblxuZnVuY3Rpb24gZGV0ZWN0SW5zdGFsbGF0aW9uU2NvcGUoXG4gICAgcHJvamVjdERpcjogc3RyaW5nLFxuKTogXCJwcm9qZWN0XCIgfCBcImdsb2JhbFwiIHwgbnVsbCB7XG4gICAgY29uc3QgY29uZmlnID0gZmluZE9wZW5Db2RlQ29uZmlnKHByb2plY3REaXIpO1xuICAgIGlmIChjb25maWcpIHJldHVybiBjb25maWcuaXNHbG9iYWwgPyBcImdsb2JhbFwiIDogXCJwcm9qZWN0XCI7XG5cbiAgICAvLyBJZiBubyBjb25maWcgZXhpc3RzLCBjaGVjayBpZiB3ZSdyZSBpbiBhIHByb2plY3Qgd2l0aCBwYWNrYWdlLmpzb25cbiAgICBpZiAoZnMuZXhpc3RzU3luYyhwYXRoLmpvaW4ocHJvamVjdERpciwgXCJwYWNrYWdlLmpzb25cIikpKSB7XG4gICAgICAgIHJldHVybiBcInByb2plY3RcIjtcbiAgICB9XG5cbiAgICByZXR1cm4gXCJnbG9iYWxcIjtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcnVuSW5zdGFsbGVyKGZsYWdzOiBJbnN0YWxsRmxhZ3MpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBwcm9qZWN0RGlyID0gcHJvY2Vzcy5jd2QoKTtcbiAgICBjb25zdCBob21lRGlyID0gcHJvY2Vzcy5lbnYuSE9NRSB8fCBwcm9jZXNzLmVudi5VU0VSUFJPRklMRSB8fCBcIlwiO1xuICAgIGNvbnN0IGRpc3RPcGVuQ29kZURpciA9IHBhdGguam9pbihST09ULCBcImRpc3RcIiwgXCIub3BlbmNvZGVcIik7XG5cbiAgICAvLyBEZXRlcm1pbmUgaW5zdGFsbGF0aW9uIHNjb3BlXG4gICAgbGV0IHNjb3BlID0gZmxhZ3Muc2NvcGU7XG4gICAgaWYgKCFzY29wZSB8fCBzY29wZSA9PT0gXCJhdXRvXCIpIHtcbiAgICAgICAgY29uc3QgZGV0ZWN0ZWQgPSBkZXRlY3RJbnN0YWxsYXRpb25TY29wZShwcm9qZWN0RGlyKTtcbiAgICAgICAgaWYgKCFkZXRlY3RlZCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICAgXCLinYwgQ291bGQgbm90IGRldGVjdCBpbnN0YWxsYXRpb24gc2NvcGUuIFVzZSAtLXNjb3BlIHByb2plY3R8Z2xvYmFsXCIsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG4gICAgICAgIHNjb3BlID0gZGV0ZWN0ZWQ7XG4gICAgfVxuXG4gICAgY29uc3QgdGFyZ2V0T3BlbkNvZGVEaXIgPVxuICAgICAgICBzY29wZSA9PT0gXCJnbG9iYWxcIlxuICAgICAgICAgICAgPyBwYXRoLmpvaW4oaG9tZURpciwgXCIuY29uZmlnXCIsIFwib3BlbmNvZGVcIilcbiAgICAgICAgICAgIDogcGF0aC5qb2luKHByb2plY3REaXIsIFwiLm9wZW5jb2RlXCIpO1xuXG4gICAgaWYgKGZsYWdzLnZlcmJvc2UpIHtcbiAgICAgICAgY29uc29sZS5sb2coYEluc3RhbGxpbmcgdG86ICR7dGFyZ2V0T3BlbkNvZGVEaXJ9YCk7XG4gICAgICAgIGNvbnNvbGUubG9nKGBTY29wZTogJHtzY29wZX1gKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSB0YXJnZXQgZGlyZWN0b3J5XG4gICAgaWYgKHNjb3BlID09PSBcInByb2plY3RcIikge1xuICAgICAgICBjb25zdCBvcGVuY29kZURpciA9IHBhdGguam9pbihwcm9qZWN0RGlyLCBcIi5vcGVuY29kZVwiKTtcbiAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKG9wZW5jb2RlRGlyKSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCLinYwgTm8gLm9wZW5jb2RlLyBkaXJlY3RvcnkgZm91bmQgaW4gcHJvamVjdFwiKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiICAgUnVuICdvcGVuY29kZSBpbml0JyBmaXJzdCBvciB1c2UgLS1zY29wZSBnbG9iYWxcIik7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgYWktZW5nLXN5c3RlbSBwbHVnaW4gcmVmZXJlbmNlXG4gICAgY29uc3QgY29uZmlnID0gZmluZE9wZW5Db2RlQ29uZmlnKHByb2plY3REaXIpO1xuICAgIGlmIChjb25maWcgJiYgIWlzUGx1Z2luUmVmZXJlbmNlZChjb25maWcucGF0aCkpIHtcbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICBcIuKaoO+4jyAgb3BlbmNvZGUuanNvbmMgZG9lcyBub3QgcmVmZXJlbmNlIGFpLWVuZy1zeXN0ZW0gcGx1Z2luXCIsXG4gICAgICAgICk7XG4gICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgXCIgICBBZGQgJ2FpLWVuZy1zeXN0ZW0nIHRvIHRoZSBwbHVnaW4gYXJyYXkgaW4gb3BlbmNvZGUuanNvbmNcIixcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoZmxhZ3MuZHJ5UnVuKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwi8J+UjSBkcnktcnVuOiBXb3VsZCBpbnN0YWxsIHRoZSBmb2xsb3dpbmcgZmlsZXM6XCIpO1xuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgIGAgICBDb21tYW5kcyAtPiAke3RhcmdldE9wZW5Db2RlRGlyfS9jb21tYW5kLyR7TkFNRVNQQUNFX1BSRUZJWH0vYCxcbiAgICAgICAgKTtcbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICBgICAgQWdlbnRzICAgLT4gJHt0YXJnZXRPcGVuQ29kZURpcn0vYWdlbnQvJHtOQU1FU1BBQ0VfUFJFRklYfS9gLFxuICAgICAgICApO1xuICAgICAgICBjb25zb2xlLmxvZyhgICAgU2tpbGxzICAgLT4gJHt0YXJnZXRPcGVuQ29kZURpcn0vc2tpbGwvYCk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBJbnN0YWxsIGNvbW1hbmRzXG4gICAgY29uc3QgY29tbWFuZHNEaXIgPSBwYXRoLmpvaW4oXG4gICAgICAgIHRhcmdldE9wZW5Db2RlRGlyLFxuICAgICAgICBcImNvbW1hbmRcIixcbiAgICAgICAgTkFNRVNQQUNFX1BSRUZJWCxcbiAgICApO1xuICAgIGNvbnN0IGRpc3RDb21tYW5kc0RpciA9IHBhdGguam9pbihcbiAgICAgICAgZGlzdE9wZW5Db2RlRGlyLFxuICAgICAgICBcImNvbW1hbmRcIixcbiAgICAgICAgTkFNRVNQQUNFX1BSRUZJWCxcbiAgICApO1xuXG4gICAgaWYgKGZzLmV4aXN0c1N5bmMoZGlzdENvbW1hbmRzRGlyKSkge1xuICAgICAgICBhd2FpdCBjbGVhbk5hbWVzcGFjZWREaXJlY3RvcnkoXG4gICAgICAgICAgICB0YXJnZXRPcGVuQ29kZURpcixcbiAgICAgICAgICAgIFwiY29tbWFuZFwiLFxuICAgICAgICAgICAgTkFNRVNQQUNFX1BSRUZJWCxcbiAgICAgICAgKTtcbiAgICAgICAgZnMuY3BTeW5jKGRpc3RDb21tYW5kc0RpciwgY29tbWFuZHNEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgICAgICBjb25zb2xlLmxvZyhgICDinIUgSW5zdGFsbGVkIGNvbW1hbmRzIHRvICR7Y29tbWFuZHNEaXJ9YCk7XG4gICAgfVxuXG4gICAgLy8gSW5zdGFsbCBhZ2VudHNcbiAgICBjb25zdCBhZ2VudHNEaXIgPSBwYXRoLmpvaW4odGFyZ2V0T3BlbkNvZGVEaXIsIFwiYWdlbnRcIiwgTkFNRVNQQUNFX1BSRUZJWCk7XG4gICAgY29uc3QgZGlzdEFnZW50c0RpciA9IHBhdGguam9pbihkaXN0T3BlbkNvZGVEaXIsIFwiYWdlbnRcIiwgTkFNRVNQQUNFX1BSRUZJWCk7XG5cbiAgICBpZiAoZnMuZXhpc3RzU3luYyhkaXN0QWdlbnRzRGlyKSkge1xuICAgICAgICBhd2FpdCBjbGVhbk5hbWVzcGFjZWREaXJlY3RvcnkoXG4gICAgICAgICAgICB0YXJnZXRPcGVuQ29kZURpcixcbiAgICAgICAgICAgIFwiYWdlbnRcIixcbiAgICAgICAgICAgIE5BTUVTUEFDRV9QUkVGSVgsXG4gICAgICAgICk7XG4gICAgICAgIGZzLmNwU3luYyhkaXN0QWdlbnRzRGlyLCBhZ2VudHNEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgICAgICBjb25zb2xlLmxvZyhgICDinIUgSW5zdGFsbGVkIGFnZW50cyB0byAke2FnZW50c0Rpcn1gKTtcbiAgICB9XG5cbiAgICAvLyBJbnN0YWxsIHNraWxsc1xuICAgIGNvbnN0IHNraWxsc0RpciA9IHBhdGguam9pbih0YXJnZXRPcGVuQ29kZURpciwgXCJza2lsbFwiKTtcbiAgICBjb25zdCBkaXN0U2tpbGxzRGlyID0gcGF0aC5qb2luKGRpc3RPcGVuQ29kZURpciwgXCJza2lsbFwiKTtcblxuICAgIGlmIChmcy5leGlzdHNTeW5jKGRpc3RTa2lsbHNEaXIpKSB7XG4gICAgICAgIGF3YWl0IGNsZWFuQWlFbmdTa2lsbHModGFyZ2V0T3BlbkNvZGVEaXIsIGRpc3RPcGVuQ29kZURpcik7XG4gICAgICAgIGZzLmNwU3luYyhkaXN0U2tpbGxzRGlyLCBza2lsbHNEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgICAgICBjb25zb2xlLmxvZyhgICDinIUgSW5zdGFsbGVkIHNraWxscyB0byAke3NraWxsc0Rpcn1gKTtcbiAgICB9XG5cbiAgICBjb25zb2xlLmxvZyhcIlxcbuKchSBJbnN0YWxsYXRpb24gY29tcGxldGUhXCIpO1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBcIiAgIFJlc3RhcnQgT3BlbkNvZGUgb3IgQ2xhdWRlIENvZGUgdG8gdXNlIG5ldyBjb21tYW5kcyBhbmQgYWdlbnRzLlwiLFxuICAgICk7XG59XG5cbmV4cG9ydCB7IHJ1bkluc3RhbGxlciB9O1xuIgogIF0sCiAgIm1hcHBpbmdzIjogIjtBQU9BO0FBQ0E7QUFDQTtBQUVBLElBQU0sY0FBYSxjQUFjLFlBQVksR0FBRztBQUNoRCxJQUFNLGFBQVksS0FBSyxRQUFRLFdBQVU7QUFDekMsSUFBTSxPQUFPLEtBQUssUUFBUSxVQUFTO0FBQ25DLElBQU0sbUJBQW1CO0FBU3pCLGVBQWUsd0JBQXdCLENBQ25DLFNBQ0EsUUFDQSxXQUNBLFNBQVMsT0FDSTtBQUFBLEVBQ2IsTUFBTSxNQUFNLEtBQUssS0FBSyxTQUFTLFFBQVEsU0FBUztBQUFBLEVBQ2hELElBQUksR0FBRyxXQUFXLEdBQUcsR0FBRztBQUFBLElBQ3BCLEdBQUcsT0FBTyxLQUFLLEVBQUUsV0FBVyxNQUFNLE9BQU8sS0FBSyxDQUFDO0FBQUEsSUFDL0MsSUFBSSxDQUFDLFFBQVE7QUFBQSxNQUNULFFBQVEsSUFBSSx3QkFBdUIsVUFBVSxZQUFZO0FBQUEsSUFDN0Q7QUFBQSxFQUNKO0FBQUE7QUFHSixlQUFlLGdCQUFnQixDQUMzQixtQkFDQSxpQkFDQSxTQUFTLE9BQ0k7QUFBQSxFQUNiLE1BQU0saUJBQWlCLEtBQUssS0FBSyxtQkFBbUIsT0FBTztBQUFBLEVBQzNELE1BQU0sZUFBZSxLQUFLLEtBQUssaUJBQWlCLE9BQU87QUFBQSxFQUN2RCxJQUFJLENBQUMsR0FBRyxXQUFXLFlBQVk7QUFBQSxJQUFHO0FBQUEs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QkFBbUIsU0FBUyxnQkFBZ0I7QUFBQSxFQUN4RSxNQUFNLGdCQUFnQixLQUFLLEtBQUssaUJBQWlCLFNBQVMsZ0JBQWdCO0FBQUEsRUFFMUUsSUFBSSxHQUFHLFdBQVcsYUFBYSxHQUFHO0FBQUEsSUFDOUIsTUFBTSx5QkFDRixtQkFDQSxTQUNBLGdCQUNKO0FBQUEsSUFDQSxHQUFHLE9BQU8sZUFBZSxXQUFXLEVBQUUsV0FBVyxLQUFLLENBQUM7QUFBQSxJQUN2RCxRQUFRLElBQUksMkJBQTBCLFdBQVc7QUFBQSxFQUNyRDtBQUFBLEVBR0EsTUFBTSxZQUFZLEtBQUssS0FBSyxtQkFBbUIsT0FBTztBQUFBLEVBQ3RELE1BQU0sZ0JBQWdCLEtBQUssS0FBSyxpQkFBaUIsT0FBTztBQUFBLEVBRXhELElBQUksR0FBRyxXQUFXLGFBQWEsR0FBRztBQUFBLElBQzlCLE1BQU0saUJBQWlCLG1CQUFtQixlQUFlO0FBQUEsSUFDekQsR0FBRyxPQUFPLGVBQWUsV0FBVyxFQUFFLFdBQVcsS0FBSyxDQUFDO0FBQUEsSUFDdkQsUUFBUSxJQUFJLDJCQUEwQixXQUFXO0FBQUEsRUFDckQ7QUFBQSxFQUVBLFFBQVEsSUFBSTtBQUFBLHlCQUEyQjtBQUFBLEVBQ3ZDLFFBQVEsSUFDSixvRUFDSjtBQUFBOyIsCiAgImRlYnVnSWQiOiAiRThGMUJBNzlBMEY5NzQwMDY0NzU2RTIxNjQ3NTZFMjEiLAogICJuYW1lcyI6IFtdCn0=
