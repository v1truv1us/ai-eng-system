// src/context/exporters/markdown.ts
import { mkdir, writeFile } from "node:fs/promises";
import { join } from "node:path";
function pad2(n) {
  return n.toString().padStart(2, "0");
}
function fileSafe(value) {
  return value.replace(/[^a-zA-Z0-9._-]+/g, "-").replace(/^-+|-+$/g, "");
}
function formatTimestampForFile(d) {
  return `${d.getFullYear()}${pad2(d.getMonth() + 1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
}
function toMarkdown(envelope) {
  const lines = [];
  lines.push(`# Command Envelope: ${envelope.commandName}`);
  lines.push("");
  lines.push(`- **ID:** ${envelope.id}`);
  lines.push(`- **Created:** ${envelope.createdAt}`);
  lines.push(`- **Status:** ${envelope.status}`);
  lines.push(`- **Duration:** ${envelope.durationMs}ms`);
  if (envelope.project)
    lines.push(`- **Project:** ${envelope.project}`);
  if (envelope.sessionId)
    lines.push(`- **Session:** ${envelope.sessionId}`);
  if (envelope.tags?.length) {
    lines.push(`- **Tags:** ${envelope.tags.join(", ")}`);
  }
  if (envelope.inputs && Object.keys(envelope.inputs).length > 0) {
    lines.push("");
    lines.push("## Inputs");
    lines.push("```json");
    lines.push(JSON.stringify(envelope.inputs, null, 2));
    lines.push("```");
  }
  if (envelope.outputSummary) {
    lines.push("");
    lines.push("## Output Summary");
    lines.push(envelope.outputSummary);
  }
  if (envelope.filesTouched && envelope.filesTouched.length > 0) {
    lines.push("");
    lines.push("## Files Touched");
    envelope.filesTouched.forEach((f) => lines.push(`- ${f}`));
  }
  if (envelope.decisions && envelope.decisions.length > 0) {
    lines.push("");
    lines.push("## Decisions");
    envelope.decisions.forEach((d) => lines.push(`- ${d}`));
  }
  if (envelope.error) {
    lines.push("");
    lines.push("## Error");
    lines.push("```");
    lines.push(`${envelope.error.name ?? "Error"}: ${envelope.error.message}`);
    if (envelope.error.stack) {
      lines.push("");
      lines.push(envelope.error.stack);
    }
    lines.push("```");
  }
  lines.push("");
  return lines.join(`
`);
}

class MarkdownContextExporter {
  outputDir;
  constructor(config) {
    this.outputDir = config.export?.markdown?.outputDir || ".ai-context/exports";
  }
  async exportEnvelope(envelope) {
    await mkdir(this.outputDir, { recursive: true });
    const created = new Date(envelope.createdAt);
    const prefix = formatTimestampForFile(created);
    const fileName = `${prefix}_${fileSafe(envelope.commandName)}_${fileSafe(envelope.id)}.md`;
    const path = join(this.outputDir, fileName);
    await writeFile(path, toMarkdown(envelope), "utf-8");
  }
}
export {
  MarkdownContextExporter
};

//# debugId=AED29D834280F75864756E2164756E21
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vc3JjL2NvbnRleHQvZXhwb3J0ZXJzL21hcmtkb3duLnRzIl0sCiAgInNvdXJjZXNDb250ZW50IjogWwogICAgIi8qKlxuICogTWFya2Rvd24gZXhwb3J0ZXIgZm9yIENvbW1hbmRDb250ZXh0RW52ZWxvcGUuXG4gKi9cblxuaW1wb3J0IHsgbWtkaXIsIHdyaXRlRmlsZSB9IGZyb20gXCJub2RlOmZzL3Byb21pc2VzXCI7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSBcIm5vZGU6cGF0aFwiO1xuaW1wb3J0IHR5cGUgeyBDb21tYW5kQ29udGV4dEVudmVsb3BlLCBDb250ZXh0Q29uZmlnIH0gZnJvbSBcIi4uL3R5cGVzXCI7XG5pbXBvcnQgdHlwZSB7IENvbnRleHRFeHBvcnRlciB9IGZyb20gXCIuL3R5cGVzXCI7XG5cbmZ1bmN0aW9uIHBhZDIobjogbnVtYmVyKTogc3RyaW5nIHtcbiAgICByZXR1cm4gbi50b1N0cmluZygpLnBhZFN0YXJ0KDIsIFwiMFwiKTtcbn1cblxuZnVuY3Rpb24gZmlsZVNhZmUodmFsdWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoL1teYS16QS1aMC05Ll8tXSsvZywgXCItXCIpLnJlcGxhY2UoL14tK3wtKyQvZywgXCJcIik7XG59XG5cbmZ1bmN0aW9uIGZvcm1hdFRpbWVzdGFtcEZvckZpbGUoZDogRGF0ZSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGAke2QuZ2V0RnVsbFllYXIoKX0ke3BhZDIoZC5nZXRNb250aCgpICsgMSl9JHtwYWQyKGQuZ2V0RGF0ZSgpKX0tJHtwYWQyKGQuZ2V0SG91cnMoKSl9JHtwYWQyKGQuZ2V0TWludXRlcygpKX0ke3BhZDIoZC5nZXRTZWNvbmRzKCkpfWA7XG59XG5cbmZ1bmN0aW9uIHRvTWFya2Rvd24oZW52ZWxvcGU6IENvbW1hbmRDb250ZXh0RW52ZWxvcGUpOiBzdHJpbmcge1xuICAgIGNvbnN0IGxpbmVzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgbGluZXMucHVzaChgIyBDb21tYW5kIEVudmVsb3BlOiAke2VudmVsb3BlLmNvbW1hbmROYW1lfWApO1xuICAgIGxpbmVzLnB1c2goXCJcIik7XG4gICAgbGluZXMucHVzaChgLSAqKklEOioqICR7ZW52ZWxvcGUuaWR9YCk7XG4gICAgbGluZXMucHVzaChgLSAqKkNyZWF0ZWQ6KiogJHtlbnZlbG9wZS5jcmVhdGVkQXR9YCk7XG4gICAgbGluZXMucHVzaChgLSAqKlN0YXR1czoqKiAke2VudmVsb3BlLnN0YXR1c31gKTtcbiAgICBsaW5lcy5wdXNoKGAtICoqRHVyYXRpb246KiogJHtlbnZlbG9wZS5kdXJhdGlvbk1zfW1zYCk7XG5cbiAgICBpZiAoZW52ZWxvcGUucHJvamVjdCkgbGluZXMucHVzaChgLSAqKlByb2plY3Q6KiogJHtlbnZlbG9wZS5wcm9qZWN0fWApO1xuICAgIGlmIChlbnZlbG9wZS5zZXNzaW9uSWQpIGxpbmVzLnB1c2goYC0gKipTZXNzaW9uOioqICR7ZW52ZWxvcGUuc2Vzc2lvbklkfWApO1xuXG4gICAgaWYgKGVudmVsb3BlLnRhZ3M/Lmxlbmd0aCkge1xuICAgICAgICBsaW5lcy5wdXNoKGAtICoqVGFnczoqKiAke2VudmVsb3BlLnRhZ3Muam9pbihcIiwgXCIpfWApO1xuICAgIH1cblxuICAgIGlmIChlbnZlbG9wZS5pbnB1dHMgJiYgT2JqZWN0LmtleXMoZW52ZWxvcGUuaW5wdXRzKS5sZW5ndGggPiAwKSB7XG4gICAgICAgIGxpbmVzLnB1c2goXCJcIik7XG4gICAgICAgIGxpbmVzLnB1c2goXCIjIyBJbnB1dHNcIik7XG4gICAgICAgIGxpbmVzLnB1c2goXCJgYGBqc29uXCIpO1xuICAgICAgICBsaW5lcy5wdXNoKEpTT04uc3RyaW5naWZ5KGVudmVsb3BlLmlucHV0cywgbnVsbCwgMikpO1xuICAgICAgICBsaW5lcy5wdXNoKFwiYGBgXCIpO1xuICAgIH1cblxuICAgIGlmIChlbnZlbG9wZS5vdXRwdXRTdW1tYXJ5KSB7XG4gICAgICAgIGxpbmVzLnB1c2goXCJcIik7XG4gICAgICAgIGxpbmVzLnB1c2goXCIjIyBPdXRwdXQgU3VtbWFyeVwiKTtcbiAgICAgICAgbGluZXMucHVzaChlbnZlbG9wZS5vdXRwdXRTdW1tYXJ5KTtcbiAgICB9XG5cbiAgICBpZiAoZW52ZWxvcGUuZmlsZXNUb3VjaGVkICYmIGVudmVsb3BlLmZpbGVzVG91Y2hlZC5sZW5ndGggPiAwKSB7XG4gICAgICAgIGxpbmVzLnB1c2goXCJcIik7XG4gICAgICAgIGxpbmVzLnB1c2goXCIjIyBGaWxlcyBUb3VjaGVkXCIpO1xuICAgICAgICBlbnZlbG9wZS5maWxlc1RvdWNoZWQuZm9yRWFjaCgoZikgPT4gbGluZXMucHVzaChgLSAke2Z9YCkpO1xuICAgIH1cblxuICAgIGlmIChlbnZlbG9wZS5kZWNpc2lvbnMgJiYgZW52ZWxvcGUuZGVjaXNpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgbGluZXMucHVzaChcIlwiKTtcbiAgICAgICAgbGluZXMucHVzaChcIiMjIERlY2lzaW9uc1wiKTtcbiAgICAgICAgZW52ZWxvcGUuZGVjaXNpb25zLmZvckVhY2goKGQpID0+IGxpbmVzLnB1c2goYC0gJHtkfWApKTtcbiAgICB9XG5cbiAgICBpZiAoZW52ZWxvcGUuZXJyb3IpIHtcbiAgICAgICAgbGluZXMucHVzaChcIlwiKTtcbiAgICAgICAgbGluZXMucHVzaChcIiMjIEVycm9yXCIpO1xuICAgICAgICBsaW5lcy5wdXNoKFwiYGBgXCIpO1xuICAgICAgICBsaW5lcy5wdXNoKFxuICAgICAgICAgICAgYCR7ZW52ZWxvcGUuZXJyb3IubmFtZSA/PyBcIkVycm9yXCJ9OiAke2VudmVsb3BlLmVycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKGVudmVsb3BlLmVycm9yLnN0YWNrKSB7XG4gICAgICAgICAgICBsaW5lcy5wdXNoKFwiXCIpO1xuICAgICAgICAgICAgbGluZXMucHVzaChlbnZlbG9wZS5lcnJvci5zdGFjayk7XG4gICAgICAgIH1cbiAgICAgICAgbGluZXMucHVzaChcImBgYFwiKTtcbiAgICB9XG5cbiAgICBsaW5lcy5wdXNoKFwiXCIpO1xuICAgIHJldHVybiBsaW5lcy5qb2luKFwiXFxuXCIpO1xufVxuXG5leHBvcnQgY2xhc3MgTWFya2Rvd25Db250ZXh0RXhwb3J0ZXIgaW1wbGVtZW50cyBDb250ZXh0RXhwb3J0ZXIge1xuICAgIHByaXZhdGUgb3V0cHV0RGlyOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IENvbnRleHRDb25maWcpIHtcbiAgICAgICAgdGhpcy5vdXRwdXREaXIgPVxuICAgICAgICAgICAgY29uZmlnLmV4cG9ydD8ubWFya2Rvd24/Lm91dHB1dERpciB8fCBcIi5haS1jb250ZXh0L2V4cG9ydHNcIjtcbiAgICB9XG5cbiAgICBhc3luYyBleHBvcnRFbnZlbG9wZShlbnZlbG9wZTogQ29tbWFuZENvbnRleHRFbnZlbG9wZSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBhd2FpdCBta2Rpcih0aGlzLm91dHB1dERpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG5cbiAgICAgICAgY29uc3QgY3JlYXRlZCA9IG5ldyBEYXRlKGVudmVsb3BlLmNyZWF0ZWRBdCk7XG4gICAgICAgIGNvbnN0IHByZWZpeCA9IGZvcm1hdFRpbWVzdGFtcEZvckZpbGUoY3JlYXRlZCk7XG4gICAgICAgIGNvbnN0IGZpbGVOYW1lID0gYCR7cHJlZml4fV8ke2ZpbGVTYWZlKGVudmVsb3BlLmNvbW1hbmROYW1lKX1fJHtmaWxlU2FmZShlbnZlbG9wZS5pZCl9Lm1kYDtcblxuICAgICAgICBjb25zdCBwYXRoID0gam9pbih0aGlzLm91dHB1dERpciwgZmlsZU5hbWUpO1xuICAgICAgICBhd2FpdCB3cml0ZUZpbGUocGF0aCwgdG9NYXJrZG93bihlbnZlbG9wZSksIFwidXRmLThcIik7XG4gICAgfVxufVxuIgogIF0sCiAgIm1hcHBpbmdzIjogIjtBQUlBO0FBQ0E7QUFJQSxTQUFTLElBQUksQ0FBQyxHQUFtQjtBQUFBLEVBQzdCLE9BQU8sRUFB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S0FBSyxFQUFFO0FBQUEsRUFDYixPQUFPLE1BQU0sS0FBSztBQUFBLENBQUk7QUFBQTtBQUFBO0FBR25CLE1BQU0sd0JBQW1EO0FBQUEsRUFDcEQ7QUFBQSxFQUVSLFdBQVcsQ0FBQyxRQUF1QjtBQUFBLElBQy9CLEtBQUssWUFDRCxPQUFPLFFBQVEsVUFBVSxhQUFhO0FBQUE7QUFBQSxPQUd4QyxlQUFjLENBQUMsVUFBaUQ7QUFBQSxJQUNsRSxNQUFNLE1BQU0sS0FBSyxXQUFXLEVBQUUsV0FBVyxLQUFLLENBQUM7QUFBQSxJQUUvQyxNQUFNLFVBQVUsSUFBSSxLQUFLLFNBQVMsU0FBUztBQUFBLElBQzNDLE1BQU0sU0FBUyx1QkFBdUIsT0FBTztBQUFBLElBQzdDLE1BQU0sV0FBVyxHQUFHLFVBQVUsU0FBUyxTQUFTLFdBQVcsS0FBSyxTQUFTLFNBQVMsRUFBRTtBQUFBLElBRXBGLE1BQU0sT0FBTyxLQUFLLEtBQUssV0FBVyxRQUFRO0FBQUEsSUFDMUMsTUFBTSxVQUFVLE1BQU0sV0FBVyxRQUFRLEdBQUcsT0FBTztBQUFBO0FBRTNEOyIsCiAgImRlYnVnSWQiOiAiQUVEMjlEODM0MjgwRjc1ODY0NzU2RTIxNjQ3NTZFMjEiLAogICJuYW1lcyI6IFtdCn0=
