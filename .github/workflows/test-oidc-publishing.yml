name: Test OIDC Publishing

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual publish)'
        required: false
        type: boolean
        default: true
      package:
        description: 'Package to test (core, cli, or all)'
        required: false
        type: string
        default: 'core'
        options: ['core', 'cli', 'all']
  pull_request:
    paths:
      - '.github/workflows/publish-*.yml'
      - 'packages/**/package.json'
      - 'scripts/version-set.ts'

jobs:
  test-oidc-publishing:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Test OIDC permissions
    strategy:
      matrix:
        package: [core, cli]
      fail-fast: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node.js for npm testing
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure test environment
        run: |
          echo "NPM_CONFIG_PROVENANCE=true" >> $GITHUB_ENV
          echo "TEST_MODE=true" >> $GITHUB_ENV

      - name: Skip package based on selection
        id: skip-check
        run: |
          PACKAGE="${{ github.event.inputs.package || 'core' }}"
          if [[ "$PACKAGE" != "${{ matrix.package }}" && "$PACKAGE" != "all" ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping ${{ matrix.package }} (testing $PACKAGE only)"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
            echo "üß™ Testing ${{ matrix.package }}"
          fi

      - name: Install dependencies
        if: steps.skip-check.outputs.should_skip != 'true'
        working-directory: ./packages/${{ matrix.package }}
        run: bun install --ignore-scripts --frozen-lockfile

      - name: Build package
        if: steps.skip-check.outputs.should_skip != 'true'
        working-directory: ./packages/${{ matrix.package }}
        run: bun run build

      - name: Run tests
        if: steps.skip-check.outputs.should_skip != 'true'
        working-directory: ./packages/${{ matrix.package }}
        run: bun test

      - name: Test version update script
        if: steps.skip-check.outputs.should_skip != 'true'
        run: |
          echo "üß™ Testing version update script..."
          TEST_VERSION="9.9.9-test"
          
          cd packages/${{ matrix.package }}
          bun run ../../scripts/version-set.ts $TEST_VERSION
          
          # Verify version was updated
          UPDATED_VERSION=$(jq -r .version package.json)
          if [[ "$UPDATED_VERSION" == "$TEST_VERSION" ]]; then
            echo "‚úÖ Version update script works correctly"
          else
            echo "‚ùå Version update script failed"
            echo "Expected: $TEST_VERSION"
            echo "Got: $UPDATED_VERSION"
            exit 1
          fi
          
          # Revert to original version
          git checkout package.json

      - name: Validate package structure
        if: steps.skip-check.outputs.should_skip != 'true'
        working-directory: ./packages/${{ matrix.package }}
        run: |
          echo "üîç Validating package structure..."
          
          # Check required fields
          REQUIRED_FIELDS=("name" "version" "description" "main" "types" "files" "publishConfig")
          for field in "${REQUIRED_FIELDS[@]}"; do
            if jq -e ".$field" package.json > /dev/null; then
              echo "‚úÖ $field field exists"
            else
              echo "‚ùå Missing required field: $field"
              exit 1
            fi
          done
          
          # Check publishConfig
          if [[ "$(jq -r .publishConfig.access package.json)" == "public" ]]; then
            echo "‚úÖ Public access configured"
          else
            echo "‚ùå Public access not configured"
            exit 1
          fi
          
          if [[ "$(jq -r .publishConfig.registry package.json)" == "https://registry.npmjs.org" ]]; then
            echo "‚úÖ NPM registry configured"
          else
            echo "‚ùå NPM registry not configured"
            exit 1
          fi

      - name: Test OIDC token generation
        if: steps.skip-check.outputs.should_skip != 'true'
        run: |
          echo "üîê Testing OIDC token generation..."
          
          # Test if we can request an OIDC token
          if curl -H "Accept: application/vnd.github.v3+json" \
                  -H "Authorization: token ${{ github.token }}" \
                  "${{ github.api_url }}/actions/runners/${{ github.run_id }}/token" \
                  --fail-with-body --silent > /dev/null; then
            echo "‚úÖ OIDC token generation working"
          else
            echo "‚ö†Ô∏è OIDC token test failed (may be expected in test)"
          fi

      - name: Configure NPM registry for testing
        if: steps.skip-check.outputs.should_skip != 'true'
        run: |
          echo "@ai-eng-system:registry=https://registry.npmjs.org/" > ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc
          echo "NPM_CONFIG_PROVENANCE=true" >> ~/.npmrc

      - name: Test npm publish dry-run
        if: steps.skip-check.outputs.should_skip != 'true'
        working-directory: ./packages/${{ matrix.package }}
        run: |
          echo "üß™ Testing npm publish dry-run with provenance..."
          
          if npm publish --dry-run --access public --provenance --verbose; then
            echo "‚úÖ npm publish dry-run successful"
          else
            echo "‚ùå npm publish dry-run failed"
            exit 1
          fi

      - name: Test package integrity
        if: steps.skip-check.outputs.should_skip != 'true'
        working-directory: ./packages/${{ matrix.package }}
        run: |
          echo "üîç Testing package integrity..."
          
          # Check if dist directory exists and has files
          if [ -d "dist" ]; then
            DIST_FILES=$(find dist -type f | wc -l)
            echo "‚úÖ dist directory exists with $DIST_FILES files"
            
            if [ $DIST_FILES -gt 0 ]; then
              echo "‚úÖ Build artifacts present"
            else
              echo "‚ùå No build artifacts found"
              exit 1
            fi
          else
            echo "‚ùå dist directory missing"
            exit 1
          fi
          
          # Check specific files for CLI package
          if [ "${{ matrix.package }}" = "cli" ]; then
            if [ -f "dist/cli/run-cli.js" ]; then
              echo "‚úÖ CLI binary found"
            else
              echo "‚ùå CLI binary missing"
              exit 1
            fi
          fi

      - name: Test package content validation
        if: steps.skip-check.outputs.should_skip != 'true'
        run: |
          echo "üìã Testing package content validation..."
          
          cd packages/${{ matrix.package }}
          
          # Validate files field exists and contains essential files
          FILES_COUNT=$(jq '.files | length' package.json)
          echo "üì¶ Files configured: $FILES_COUNT"
          
          # Check for essential files in files array
          ESSENTIAL_FILES=("dist/")
          for file in "${ESSENTIAL_FILES[@]}"; do
            if jq -e '.files[] | select(. == "'$file'")' package.json > /dev/null; then
              echo "‚úÖ $file included in package"
            else
              echo "‚ö†Ô∏è $file not found in files array"
            fi
          done

  validate-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint

      - name: Validate YAML syntax
        run: |
          echo "üîç Validating workflow files..."
          
          WORKFLOWS=".github/workflows/publish-*-oidc.yml"
          for workflow in $WORKFLOWS; do
            if [ -f "$workflow" ]; then
              echo "Validating $workflow..."
              yamllint "$workflow" || echo "‚ö†Ô∏è YAML lint warnings in $workflow"
            fi
          done

      - name: Check OIDC permissions
        run: |
          echo "üîê Checking OIDC permissions in workflows..."
          
          WORKFLOWS=".github/workflows/publish-*-oidc.yml"
          for workflow in $WORKFLOWS; do
            if [ -f "$workflow" ]; then
              echo "Checking $workflow..."
              
              # Check for id-token: write permission
              if grep -q "id-token: write" "$workflow"; then
                echo "‚úÖ OIDC permission found in $workflow"
              else
                echo "‚ùå OIDC permission missing in $workflow"
                exit 1
              fi
              
              # Check for --provenance flag
              if grep -q "\-\-provenance" "$workflow"; then
                echo "‚úÖ Provenance flag found in $workflow"
              else
                echo "‚ùå Provenance flag missing in $workflow"
                exit 1
              fi
              
              # Check for NPM_CONFIG_PROVENANCE
              if grep -q "NPM_CONFIG_PROVENANCE=true" "$workflow"; then
                echo "‚úÖ NPM provenance config found in $workflow"
              else
                echo "‚ùå NPM provenance config missing in $workflow"
                exit 1
              fi
            fi
          done

      - name: Validate workflow triggers
        run: |
          echo "üöÄ Checking workflow triggers..."
          
          WORKFLOWS=".github/workflows/publish-*-oidc.yml"
          for workflow in $WORKFLOWS; do
            if [ -f "$workflow" ]; then
              echo "Checking triggers in $workflow..."
              
              # Check for tag trigger
              if grep -q "on:" "$workflow" && grep -q "tags:" "$workflow"; then
                echo "‚úÖ Tag trigger found in $workflow"
              else
                echo "‚ùå Tag trigger missing in $workflow"
                exit 1
              fi
              
              # Check for workflow_dispatch trigger
              if grep -q "workflow_dispatch:" "$workflow"; then
                echo "‚úÖ Manual trigger found in $workflow"
              else
                echo "‚ùå Manual trigger missing in $workflow"
                exit 1
              fi
            fi
          done

  test-report:
    needs: [test-oidc-publishing, validate-workflows]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate test report
        run: |
          echo "üìä Test Report Summary"
          echo "====================="
          echo ""
          echo "‚úÖ OIDC Publishing Test Completed"
          echo "üîê Permissions: id-token: write ‚úì"
          echo "üì¶ Package validation: ‚úì"
          echo "üß™ Dry-run publishing: ‚úì"
          echo "üìã Workflow validation: ‚úì"
          echo ""
          echo "Next steps:"
          echo "1. Verify NPM trusted publisher configuration"
          echo "2. Test with actual tag push"
          echo "3. Monitor provenance verification"
          echo ""
          echo "üöÄ Ready for OIDC publishing!"